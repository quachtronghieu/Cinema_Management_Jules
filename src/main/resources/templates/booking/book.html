<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking | CGV</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/style.css}">
    <style>
        .booking-card {
            background-color: #1c1f26;
            border-radius: 16px;
            padding: 30px;
            color: #d4d7dc;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
        .booking-card h5 {
            color: #e50914;
            font-weight: 700;
            text-transform: uppercase;
        }
        .info-label {
            font-weight: 600;
            color: #9da3af;
        }
        #voucherMessage {
            font-size: 0.9rem;
            margin-top: 8px;
        }
        .btn-apply {
            border-color: #fff;
            color: #fff;
        }
        .btn-apply:hover {
            background-color: #e50914;
            border-color: #e50914;
        }
        .btn-book {
            background-color: #e50914;
            color: white;
            font-weight: 600;
            padding: 6px 24px;
            border-radius: 8px;
        }
        .btn-book:hover {
            background-color: #ff4040;
        }
        .btn-back {
            background-color: transparent;
            border: 1.5px solid #ccc;
            color: #ccc;
            font-weight: 500;
            border-radius: 8px;
            padding: 6px 18px;
            transition: 0.25s ease;
        }
        .btn-back:hover {
            background-color: #e50914;
            border-color: #e50914;
            color: #fff;
            text-decoration: none;
        }
        .total-price {
            color: #ffcc00;
            font-weight: 700;
            font-size: 1.1rem;
        }
        select#voucherSelect {
            background-color: #2a2e38;
            border: none;
            border-radius: 6px;
            padding: 5px 10px;
            color: #fff;
            width: 220px;
            margin-right: 6px;
        }
    </style>
</head>
<body>
<header th:replace="~{fragment/frag :: navbar_homepage}"></header>

<main role="main" class="movies">
    <section id="promotions" class="section">
        <div class="container mt-4">
            <div class="section__header d-flex justify-content-between align-items-center mb-4">
                <h2 class="section__title text-light mb-0">Booking Summary</h2>
                <a th:href="@{/homepage}" class="btn-back">Back</a>
            </div>

            <div class="booking-card">
                <form id="mini-cart" th:action="@{/booking/payment}" method="post">
                    <h5 th:text="${showtime.movie.title}">The Last Guardian</h5>
                    <hr class="border-light">

                    <div class="row mb-3">
                        <div class="col-md-3 mb-2">
                            <span class="info-label">Room:</span>
                            <span th:text="${showtime.getRoom().id}">4</span>
                        </div>
                        <div class="col-md-5 mb-2">
                            <span class="info-label">Showtime:</span>
                            <span th:text="${showtime.showDate} + ' | ' + ${showtime.startTime} + ' - ' + ${endtime}"></span>
                            <input type="hidden" name="showtimeId" th:value="${showtime.showtimeId}">
                            <input type="hidden" name="endtime" th:value="${endtime}">
                        </div>
                        <div class="col-md-4 mb-2">
                            <span class="info-label">Seats:</span>
                            <span class="text-danger" th:text="${selectedSeats}"></span>
                            <input type="hidden" name="selectedSeats" th:value="${selectedSeats}">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div th:each="c, iterStat : ${concessions}" class="col-md-4 mb-2">
                            <span class="info-label">Concession:</span>
                            <span class="text-danger" th:text="${c.name}"></span> x
                            <span class="text-warning" th:text="${quantities[iterStat.index]}"></span>
                        </div>
                    </div>

                    <div class="row align-items-center mb-3">
                        <div class="col-md-4 mb-2">
                            <span class="info-label">Grand Total:</span>
                            <span id="totalPrice" class="total-price" th:text="${totalPrice}"></span> ₫
                            <input type="hidden" id="originalTotal" th:value="${totalPrice}">
                            <input type="hidden" name="totalPrice" th:value="${totalPrice}">
                        </div>

                        <!-- VOUCHER SELECT -->
                        <div class="col-md-8 mb-2 d-flex flex-wrap align-items-center">
                            <span class="info-label me-2">Voucher:</span>

                            <select id="voucherSelect" name="voucherCode" class="form-select bg-dark text-light me-2" style="width: 200px;">
                                <option value="">-- Select a voucher --</option>
                                <option th:each="v : ${availableVouchers}"
                                        th:value="${v.code}"
                                        th:text="${v.voucherName + ' (' + v.discountValue + (v.discountType == 'Percentage' ? '% OFF' : '₫ OFF') + ')'}">
                                </option>
                            </select>

                            <button id="applyVoucherBtn" type="button" class="btn btn-apply btn-sm">Apply</button>
                            <p id="voucherMessage" class="fw-bold ms-3 mb-0"></p>
                        </div>

                    </div>

                    <div class="text-end mt-3">
                        <button id="confirm-btn" class="btn-book" type="submit">Book</button>
                    </div>
                </form>
            </div>
        </div>
    </section>
</main>

<footer th:replace="~{fragment/frag :: footer_homepage}"></footer>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const applyBtn = document.getElementById("applyVoucherBtn");
        const totalEl = document.getElementById("totalPrice");
        const voucherSelect = document.getElementById("voucherSelect");
        const msgEl = document.getElementById("voucherMessage");
        const originalInput = document.getElementById("originalTotal");

        if (applyBtn && totalEl && voucherSelect) {
            applyBtn.addEventListener("click", function () {
                const code = voucherSelect.value.trim();
                if (!code) {
                    msgEl.textContent = "Please select a voucher.";
                    msgEl.style.color = "orange";
                    return;
                }

                const baseTotal = parseFloat(originalInput.value.replace(/[^\d.]/g, '')) || 0;

                fetch(`/booking/apply-voucher?code=${encodeURIComponent(code)}&totalPrice=${baseTotal}`, {
                    method: "POST"
                })
                    .then(response => {
                        if (!response.ok) throw new Error("Invalid voucher");
                        return response.text();
                    })
                    .then(newPrice => {
                        const cleanPrice = parseFloat(newPrice);
                        totalEl.textContent = cleanPrice.toLocaleString('vi-VN');
                        const totalInput = document.querySelector('input[name="totalPrice"]');
                        if (totalInput) totalInput.value = cleanPrice;

                        msgEl.textContent = "Voucher applied successfully.";
                        msgEl.style.color = "lightgreen";
                    })
                    .catch(() => {
                        msgEl.textContent = "Voucher is invalid or expired.";
                        msgEl.style.color = "red";
                    });
            });
        }
    });

</script>

<script th:src="@{/assets/js/bootstrap.bundle.min.js}"></script>
</body>
</html>
