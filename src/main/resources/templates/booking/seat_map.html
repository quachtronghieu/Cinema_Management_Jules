<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Seat - The Last Guardian - CGV Cinema</title>
    <meta name="description"
          content="Select your seats for The Last Guardian at CGV Cinema. Choose from available seats with premium VIP options.">
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@500;700&display=swap"
          rel="stylesheet"/>

    <link rel="stylesheet" th:href="@{/assets/css/style.css}">
    <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/seat_template.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet"/>
</head>

<body>
<header th:replace="~{fragment/frag :: navbar_homepage}"></header>


<!-- Main Content -->
<main role="main">
    <!-- Seat Selection -->
    <section class="section pt-0">

        <div class="container">
            <input type="radio" id="tpl1" name="tpl" th:checked="${template == 'TM000001'}" hidden="">
            <input type="radio" id="tpl2" name="tpl" th:checked="${template == 'TM000002'}" hidden="">
            <input type="radio" id="tpl3" name="tpl" th:checked="${template == 'TM000003'}" hidden="">
            <input type="radio" id="tpl4" name="tpl" th:checked="${template == 'TM000004'}" hidden="">

            <div class="section__header section-header mt-3">
                <h2 class="section__title">Seat Map</h2>
                <a th:href="@{'/booking/' + ${showtime.movie.movieID} + '?date=' + ${showtime.getShowDate()}}" class="btn btn-light btn-sm mt-2">
                    ‚Üê Back
                </a>
            </div>
            <div class="seat-map bg-secondary">

                <!-- Screen -->
                <div class="seat-map__screen">SCREEN</div>


                <div class="templates">

                    <!-- TEMPLATE 1: existing layout -->
                    <div id="template-1" class="template-section"
                         th:if="${template == 'TM000001'}">

                        <div th:each="entry : ${groupSeat}">
                            <!-- Seat Map Grid -->
                            <!--Seat Map Grid Layout 1-->
                            <div class="seat-map__grid .Row">
                                <!-- Row A -->
                                <div class="row">
                                    <div th:each="seats : ${entry.getValue()}" class="seat seat"
                                         th:classappend=" 'seat--' + ${seats.getSeatType()}"
                                         th:text="${seats.getRowLabel()} + ${seats.getSeatNumber()}"
                                         th:attr="data-seat=${seats.getRowLabel() + seats.getSeatNumber()},
                                                  data-status=${seatStatusMap[seats.id]},
                                                  data-id=${seats.id}">
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>


                    <div id="template-2" class="template-section" th:if="${template == 'TM000002'}">

                        <div class="seat-map__grid seat-map__grid--t2">
                            <!-- Rows A-F with two aisles at columns 5 and 9 -->
                            <div class="row" th:each="entry : ${groupSeat}">
                                <div th:each="seats, iterStat : ${entry.value}">
                                    <div class="seat"
                                         th:classappend="' seat--' + ${seats.getSeatType()} +
                                    (${seatStatusMap[seats.id]} == 'unavailable' ? ' seat--booked' : '')"
                                         th:attr="data-seat=${seats.getRowLabel() + seats.getSeatNumber()},
                                                  data-status=${seatStatusMap[seats.id]},
                                                  data-id=${seats.id}"
                                         th:text="${seats.getRowLabel()} + ${seats.getSeatNumber()}">
                                    </div>

                                    <div class="aisle" th:if="${iterStat.index == 3 or iterStat.index == 6}"></div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- TEMPLATE 3: front VIP rows + compact rear grid -->
                    <div id="template-3" class="template-section" th:if="${template == 'TM000003'}">
                        <div class="seat-map__grid seat-map__grid--t3">
                            <div class="row" th:each="entry : ${groupSeat}">
                                <div th:each="seats : ${entry.getValue()}" class="seat"
                                     th:classappend="' seat--' + ${seats.getSeatType()} +
                                 (${seatStatusMap[seats.id]} == 'unavailable' ? ' seat--booked' : '')"
                                     th:attr="data-seat=${seats.getRowLabel() + seats.getSeatNumber()},
                          data-status=${seatStatusMap[seats.id]},
                          data-id=${seats.id}"
                                     th:text="${seats.getRowLabel()} + ${seats.getSeatNumber()}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TEMPLATE 4: 8 columns, single aisle in the middle (2 blocks) -->
                    <div id="template-4" class="template-section" th:if="${template == 'TM000004'}">
                        <div class="seat-map__grid seat-map__grid--t4">
                            <div class="row" th:each="entry : ${groupSeat}">

                                <div th:each="seats, iterStat : ${entry.value}">
                                    <div class="seat" th:classappend=" 'seat--' + ${seats.getSeatType()}"
                                         th:text="${seats.getRowLabel()} + ${seats.getSeatNumber()}"
                                         th:attr="data-seat=${seats.getRowLabel() + seats.getSeatNumber()},
                                                  data-status=${seatStatusMap[seats.id]},
                                                  data-id=${seats.id}">
                                    </div>
                                    <div class="aisle" th:if="${iterStat.index == 3}">
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="seat-map__legend">
                        <div class="legend-item">
                            <div class="legend-item__color legend-item__color--available"></div>
                            <span>Standard</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-item__color legend-item__color--vip"></div>
                            <span>VIP</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-item__color legend-item__color--booked"></div>
                            <span>Booked</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-item__color legend-item__color--selected"></div>
                            <span>Selected</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mini Cart -->
            <form id="mini-cart" class="p-4 border rounded-3 bg-secondary shadow"
                  th:action="@{/booking/concessions}" method="post">

                <h5 class="mb-3 fw-bold text-primary text-center"
                    th:text="${showtime.movie.title}">
                    The Last Guardian
                </h5>

                <div class="row mb-3 align-items-center text-start">
                    <div class="col-12 col-md-1 d-flex align-items-center mb-2 mb-md-0">
                        <strong class="me-1">Room:</strong>
                        <span id="room-id" th:text="${showtime.getRoom().id}">2</span>
                    </div>

                    <div class="col-12 col-md-5 d-flex align-items-center mb-2 mb-md-0">
                        <strong class="me-1">Showtime:</strong>
                        <span id="showtime-info"
                              th:text="${showtime.showDate} + ' | ' + ${showtime.startTime}">
            </span>
                        <span class="mx-1">-</span>
                        <span id="endtime-info"></span>

                        <input type="hidden" name="showtimeId" th:value="${showtime.showtimeId}">

                        <input type="hidden" name="endtime" id="endtimeInput">
                    </div>

                    <div class="col-12 col-md-3 d-flex align-items-center mb-2 mb-md-0">
                        <strong class="me-1">Seats:</strong>
                        <span id="selected-seats" class="text-danger text-truncate">None</span>
                        <input type="hidden" name="selectedSeats" id="selectedSeatsInput">
                    </div>

                    <div class="col-12 col-md-3 d-flex align-items-center">
                        <strong class="me-1">Total:</strong>
                        <span id="total-price" class="fw-bold text-success">0 ‚Ç´</span>
                        <input type="hidden" name="totalPrice" id="totalPriceInput" value="0">
                    </div>
                </div>

                <div class="d-flex justify-content-end">
                    <button id="confirm-btn" class="btn btn-primary btn-sm fw-semibold" disabled>
                        Next ‚Üí
                    </button>
                </div>
            </form>

        </div>
    </section>
</main>
<footer th:replace="~{fragment/frag :: footer_homepage}"></footer>
</body>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // ‚úÖ Gh·∫ø ƒë√£ ƒë·∫∑t
        document.querySelectorAll('.seat--booked').forEach(seat => {
            seat.title = "This seat is already booked";
        });

        const seats = document.querySelectorAll('.seat:not(.seat--booked)');
        const selectedSeatIds = new Set();

        const selectedSeatsEl = document.getElementById("selected-seats");
        const totalPriceEl = document.getElementById("total-price");
        const confirmBtn = document.getElementById("confirm-btn");

        // üé¨ T√≠nh gi·ªù k·∫øt th√∫c d·ª±a v√†o th·ªùi l∆∞·ª£ng phim
        const startTimeText = document.querySelector('#showtime-info').textContent;
        const duration = /*[[${showtime.movie.duration}]]*/ 123; // v√≠ d·ª•: 123 ph√∫t
        const endTimeInfo = document.getElementById("endtime-info");

        try {
            const [dateStr, startStr] = startTimeText.split('|').map(s => s.trim());
            const [hour, minute] = startStr.split(':').map(Number);
            const start = new Date();
            start.setHours(hour, minute, 0);

            const end = new Date(start.getTime() + duration * 60000);

            // L√†m tr√≤n ph√∫t l√™n b·ªôi s·ªë c·ªßa 5 ho·∫∑c 10
            let endMin = end.getMinutes();
            if (endMin % 10 === 1 || endMin % 10 === 2 || endMin % 10 === 3 || endMin % 10 === 4)
                endMin = Math.floor(endMin / 10) * 10 + 5;
            else if (endMin % 10 >= 6)
                endMin = Math.ceil(endMin / 10) * 10;
            if (endMin >= 60) { end.setHours(end.getHours() + 1); endMin -= 60; }

            const formattedEnd = `${String(end.getHours()).padStart(2, '0')}:${String(endMin).padStart(2, '0')}`;
            endTimeInfo.textContent = formattedEnd;
        } catch (e) {
            endTimeInfo.textContent = "";
        }

        // ü™ë Ch·ªçn gh·∫ø
        seats.forEach(seat => {
            seat.addEventListener('click', function () {
                const seatId = this.getAttribute('data-id');
                const seatLabel = this.getAttribute('data-seat');
                const seatType = this.classList.contains('seat--vip') ? 'vip' : 'standard';
                const price = seatType === 'vip' ? 100000 : 80000;

                this.classList.toggle('seat--selected');
                this.classList.toggle('checked');

                if (this.classList.contains('seat--selected')) {
                    selectedSeatIds.add(JSON.stringify({ id: seatId, label: seatLabel, price }));
                } else {
                    selectedSeatIds.forEach(s => {
                        const obj = JSON.parse(s);
                        if (obj.id === seatId) selectedSeatIds.delete(s);
                    });
                }

                updateMiniCart();
            });
        });

        function validateSeats(seatsArr) {
            // 1Ô∏è‚É£ Ki·ªÉm tra s·ªë l∆∞·ª£ng gh·∫ø
            if (seatsArr.length > 6) {
                return "B·∫°n ch·ªâ c√≥ th·ªÉ ch·ªçn t·ªëi ƒëa 6 gh·∫ø!";
            }

            if (seatsArr.length === 0) return null;

            // 2Ô∏è‚É£ Ki·ªÉm tra gh·∫ø c√πng h√†ng
            const rows = seatsArr.map(s => s.label[0]); // L·∫•y ch·ªØ c√°i h√†ng
            const uniqueRows = [...new Set(rows)];
            if (uniqueRows.length > 1) {
                return "C√°c gh·∫ø ph·∫£i n·∫±m trong c√πng m·ªôt h√†ng!";
            }

            // 3Ô∏è‚É£ Ki·ªÉm tra gh·∫ø li√™n ti·∫øp
            const seatNumbers = seatsArr.map(s => parseInt(s.label.slice(1))).sort((a, b) => a - b);
            for (let i = 1; i < seatNumbers.length; i++) {
                if (seatNumbers[i] !== seatNumbers[i - 1] + 1) {
                    return "C√°c gh·∫ø ph·∫£i li√™n ti·∫øp trong c√πng h√†ng!";
                }
            }

            return null; // H·ª£p l·ªá
        }


        // üßæ C·∫≠p nh·∫≠t mini cart
        function updateMiniCart() {
            let seatsArr = Array.from(selectedSeatIds).map(s => JSON.parse(s));

            // Ki·ªÉm tra l·ªói
            const error = validateSeats(seatsArr);
            if (error) {
                alert(error);

                // X√°c ƒë·ªãnh gh·∫ø g√¢y l·ªói: gh·∫ø cu·ªëi c√πng ƒë∆∞·ª£c ch·ªçn
                const last = seatsArr[seatsArr.length - 1];
                selectedSeatIds.forEach(s => {
                    const obj = JSON.parse(s);
                    if (obj.id === last.id) selectedSeatIds.delete(s);
                });

                // B·ªè ch·ªçn gh·∫ø tr√™n map
                const seatEl = document.querySelector(`.seat[data-id='${last.id}']`);
                if (seatEl) {
                    seatEl.classList.remove('seat--selected', 'checked');
                }

                seatsArr = Array.from(selectedSeatIds).map(s => JSON.parse(s));
            }

            // C·∫≠p nh·∫≠t mini cart
            if (seatsArr.length > 0) {
                selectedSeatsEl.textContent = seatsArr.map(s => s.label).join(", ");
                confirmBtn.disabled = false;
            } else {
                selectedSeatsEl.textContent = "None";
                confirmBtn.disabled = true;
            }

            const total = seatsArr.reduce((sum, s) => sum + s.price, 0);
            totalPriceEl.textContent = total.toLocaleString('vi-VN') + " ‚Ç´";
        }


        // ‚úÖ Khi nh·∫•n Confirm
        confirmBtn.addEventListener('click', function (e) {
            e.preventDefault(); // kh√¥ng reload ngay

            const seatsArr = Array.from(selectedSeatIds).map(s => JSON.parse(s));
            const total = seatsArr.reduce((sum, s) => sum + s.price, 0);

            // G√°n d·ªØ li·ªáu v√†o hidden inputs
            document.getElementById('selectedSeatsInput').value = seatsArr.map(s => s.label).join(',');
            document.getElementById('totalPriceInput').value = total;
            document.getElementById('endtimeInput').value = document.getElementById('endtime-info').textContent.trim();

            // ‚úÖ G·ª≠i form
            document.getElementById('mini-cart').submit();
        });

    });
</script>



</html>