<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" th:fragment="layout(title, content)">
<head th:replace="~{fragment/frag :: head_dashboard}"></head>

<body>
<div class="container-fluid position-relative d-flex p-0">
    <!-- Sidebar -->
    <div th:replace="~{fragment/frag :: sidebar_staff}"></div>

    <!-- Content -->
    <div class="content">
        <div th:replace="~{fragment/frag :: navbar_dashboard}"></div>

        <!-- CHECK-IN MANAGEMENT -->
        <div class="container-fluid pt-4 px-4">
            <div class="bg-secondary rounded p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h6 class="mb-0">Booking Check-in Management</h6>

                    <!-- Search -->
                    <input id="searchInput" type="text"
                           class="form-control w-25 bg-dark text-white border-light"
                           placeholder="Search by Booking ID">
                </div>

                <div class="table-responsive" th:if="${tickets != null and !tickets.isEmpty()}">
                    <table id="checkinTable" class="table text-start align-middle table-bordered table-hover mb-0">
                        <thead>
                        <tr class="text-white">
                            <th scope="col">Booking ID</th>
                            <th scope="col">Ticket ID</th>
                            <th scope="col">Movie</th>
                            <th scope="col">Showtime</th>
                            <th scope="col">Room / Seat</th>
                            <th scope="col">Check-in</th>
                        </tr>
                        </thead>

                        <tbody>
                        <!-- Lặp qua danh sách vé -->
                        <tr th:each="t : ${tickets}">
                            <td th:text="${t['bookingId']}"></td>
                            <td th:text="${t['ticketId']}"></td>
                            <td th:text="${t['movieTitle']}"></td>
                            <td th:text="${t['showtime']}"></td>
                            <td th:text="${t['roomSeat']}"></td>
                            <td>
                                <a th:href="@{/staffs/checkIn_Ticket/{ticketId}(ticketId=${t['ticketId']})}" class="btn btn-danger btn-sm checkin-btn"
                                        th:if="${!t['checkedIn']}"
                                        th:attr="data-id=${t['ticketId']}">
                                    <i class="fa fa-check"></i> Check-in
                                </a>
                                <span class="badge bg-success" th:if="${t['checkedIn']}">Checked</span>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Nếu không có vé -->
                <div class="alert alert-warning text-center" th:if="${tickets == null or tickets.isEmpty()}">
                    No online tickets waiting for check-in.
                </div>


            </div>
        </div>

    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/assets/js/main.js}"></script>
<script th:src="@{/assets/js/dashboard.js}"></script>

<!-- Check-in Script -->
<script>
    // Nút check-in
    document.addEventListener('click', function (e) {
        if (e.target.closest('.checkin-btn')) {
            const btn = e.target.closest('.checkin-btn');
            btn.textContent = 'Checked';
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-secondary');
            btn.disabled = true;

            // (Tùy chọn) Gửi request lên server để cập nhật trạng thái
            fetch('/checkin/' + btn.dataset.id, {
                method: 'POST'
            }).then(r => console.log('Checked in:', btn.dataset.id));
        }
    });

    // --- SEARCH ONLY BY TICKET ID ---
    document.getElementById('searchInput').addEventListener('keyup', function () {
        const filter = this.value.toUpperCase();
        const rows = document.querySelectorAll('#checkinTable tbody tr');

        rows.forEach(row => {
            const ticketId = row.cells[1].textContent.toUpperCase();
            row.style.display = ticketId.includes(filter) ? '' : 'none';
        });
    });

</script>

</body>
</html>
